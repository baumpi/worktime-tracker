<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Arbeitszeit Tracker</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/recharts@2.10.3/umd/Recharts.min.js"></script>
  <style>
    body { background: #09090b; }
    input[type="date"]::-webkit-calendar-picker-indicator,
    input[type="time"]::-webkit-calendar-picker-indicator {
      filter: invert(1);
    }
  </style>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
    const { useState, useEffect, useRef } = React;
    const { BarChart, Bar, XAxis, YAxis, ReferenceLine, ResponsiveContainer, Cell } = Recharts;

    const API_URL = '/api';

    const WorktimeTracker = () => {
      const [entries, setEntries] = useState([]);
      const [categories, setCategories] = useState(['Arbeit', 'W2Learn', 'Voice', 'Institut', 'Admin']);
      const [view, setView] = useState('entry');
      const [loading, setLoading] = useState(true);
      const [weeklyTarget, setWeeklyTarget] = useState(35);
      const [dailyLimit, setDailyLimit] = useState(8);
      const [autoPause, setAutoPause] = useState(0);
      const [showSettings, setShowSettings] = useState(false);
      const [tempTarget, setTempTarget] = useState(35);
      const [tempDailyLimit, setTempDailyLimit] = useState(8);
      const [tempAutoPause, setTempAutoPause] = useState(0);
      const fileInputRef = useRef(null);
      
      // Entry form state
      const [entryMode, setEntryMode] = useState('range');
      const [date, setDate] = useState(new Date().toISOString().split('T')[0]);
      const [startTime, setStartTime] = useState('08:00');
      const [endTime, setEndTime] = useState('15:00');
      const [hours, setHours] = useState('');
      const [category, setCategory] = useState('Arbeit');
      const [note, setNote] = useState('');
      const [newCategory, setNewCategory] = useState('');
      const [showAddCategory, setShowAddCategory] = useState(false);
      
      // Edit state
      const [editingEntry, setEditingEntry] = useState(null);
      const [editDate, setEditDate] = useState('');
      const [editStartTime, setEditStartTime] = useState('');
      const [editEndTime, setEditEndTime] = useState('');
      const [editHours, setEditHours] = useState('');
      const [editCategory, setEditCategory] = useState('');
      const [editNote, setEditNote] = useState('');
      const [editMode, setEditMode] = useState('range');

      // API functions
      const api = {
        async getEntries() {
          const res = await fetch(`${API_URL}/entries`);
          return res.json();
        },
        async addEntry(entry) {
          const res = await fetch(`${API_URL}/entries`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(entry)
          });
          return res.json();
        },
        async updateEntry(id, entry) {
          const res = await fetch(`${API_URL}/entries/${id}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(entry)
          });
          return res.json();
        },
        async deleteEntry(id) {
          await fetch(`${API_URL}/entries/${id}`, { method: 'DELETE' });
        },
        async getSettings() {
          const res = await fetch(`${API_URL}/settings`);
          return res.json();
        },
        async saveSettings(settings) {
          const res = await fetch(`${API_URL}/settings`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(settings)
          });
          return res.json();
        },
        async importData(data) {
          const res = await fetch(`${API_URL}/import`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
          });
          return res.json();
        }
      };

      // Load data on mount
      useEffect(() => {
        const loadData = async () => {
          try {
            const entriesData = await api.getEntries();
            setEntries(entriesData);
            
            const settings = await api.getSettings();
            if (settings) {
              setWeeklyTarget(settings.weeklyTarget || 35);
              setTempTarget(settings.weeklyTarget || 35);
              setDailyLimit(settings.dailyLimit || 8);
              setTempDailyLimit(settings.dailyLimit || 8);
              setAutoPause(settings.autoPause || 0);
              setTempAutoPause(settings.autoPause || 0);
              if (settings.categories) {
                setCategories(settings.categories);
              }
            }
          } catch (e) {
            console.error('Error loading data:', e);
          }
          setLoading(false);
        };
        loadData();
      }, []);

      // Calculate hours from time range
      const calculateHours = (start, end, applyPause = false) => {
        if (!start || !end) return 0;
        const [startH, startM] = start.split(':').map(Number);
        const [endH, endM] = end.split(':').map(Number);
        let hrs = ((endH * 60 + endM) - (startH * 60 + startM)) / 60;
        if (applyPause && autoPause > 0 && hrs > 6) {
          hrs -= autoPause / 60;
        }
        return Math.max(0, hrs);
      };

      // Presets
      const applyPreset = (preset) => {
        if (preset === '8-15') {
          setStartTime('08:00');
          setEndTime('15:00');
          setEntryMode('range');
        } else if (preset === '8-12') {
          setStartTime('08:00');
          setEndTime('12:00');
          setEntryMode('range');
        } else if (preset === 'yesterday') {
          const yesterdayEntries = entries.filter(e => {
            const yesterday = new Date();
            yesterday.setDate(yesterday.getDate() - 1);
            return e.date === yesterday.toISOString().split('T')[0];
          });
          if (yesterdayEntries.length > 0) {
            const last = yesterdayEntries[yesterdayEntries.length - 1];
            if (last.startTime) {
              setEntryMode('range');
              setStartTime(last.startTime);
              setEndTime(last.endTime);
            } else {
              setEntryMode('hours');
              setHours(last.hours.toString());
            }
            setCategory(last.category);
          }
        }
      };

      // Add entry
      const addEntry = async () => {
        let entryHours = entryMode === 'range' 
          ? calculateHours(startTime, endTime, true)
          : parseFloat(hours);
        
        if (!entryHours || entryHours <= 0) return;

        const newEntry = {
          date,
          hours: entryHours,
          category,
          note,
          startTime: entryMode === 'range' ? startTime : null,
          endTime: entryMode === 'range' ? endTime : null
        };

        const saved = await api.addEntry(newEntry);
        setEntries([...entries, saved]);
        
        setHours('');
        setNote('');
        setStartTime('08:00');
        setEndTime('15:00');

        // Check daily limit
        const todayHours = getTodayHours() + entryHours;
        if (todayHours > dailyLimit) {
          alert(`⚠️ Du hast heute ${todayHours.toFixed(1)}h gearbeitet - über deinem Tageslimit von ${dailyLimit}h!`);
        }
      };

      // Delete entry
      const deleteEntry = async (id) => {
        await api.deleteEntry(id);
        setEntries(entries.filter(e => e.id !== id));
      };

      // Start editing
      const startEdit = (entry) => {
        setEditingEntry(entry.id);
        setEditDate(entry.date);
        setEditStartTime(entry.startTime || '08:00');
        setEditEndTime(entry.endTime || '15:00');
        setEditHours(entry.hours.toString());
        setEditCategory(entry.category);
        setEditNote(entry.note || '');
        setEditMode(entry.startTime ? 'range' : 'hours');
      };

      // Save edit
      const saveEdit = async () => {
        const entryHours = editMode === 'range' 
          ? calculateHours(editStartTime, editEndTime)
          : parseFloat(editHours);
        
        if (!entryHours || entryHours <= 0) return;

        const updated = await api.updateEntry(editingEntry, {
          date: editDate,
          hours: entryHours,
          category: editCategory,
          note: editNote,
          startTime: editMode === 'range' ? editStartTime : null,
          endTime: editMode === 'range' ? editEndTime : null
        });

        setEntries(entries.map(e => e.id === editingEntry ? updated : e));
        setEditingEntry(null);
      };

      // Cancel edit
      const cancelEdit = () => {
        setEditingEntry(null);
      };

      // Add category
      const addCategory = async () => {
        if (newCategory && !categories.includes(newCategory)) {
          const newCats = [...categories, newCategory];
          setCategories(newCats);
          await api.saveSettings({ 
            weeklyTarget, 
            dailyLimit, 
            autoPause, 
            categories: newCats 
          });
          setNewCategory('');
          setShowAddCategory(false);
        }
      };

      // Delete category
      const deleteCategory = async (cat) => {
        if (categories.length <= 1) return;
        const newCats = categories.filter(c => c !== cat);
        setCategories(newCats);
        if (category === cat) setCategory(newCats[0]);
        await api.saveSettings({ 
          weeklyTarget, 
          dailyLimit, 
          autoPause, 
          categories: newCats 
        });
      };

      // Save settings
      const saveSettings = async () => {
        setWeeklyTarget(tempTarget);
        setDailyLimit(tempDailyLimit);
        setAutoPause(tempAutoPause);
        await api.saveSettings({ 
          weeklyTarget: tempTarget, 
          dailyLimit: tempDailyLimit, 
          autoPause: tempAutoPause,
          categories 
        });
        setShowSettings(false);
      };

      // Export functions
      const exportJSON = () => {
        const data = { entries, settings: { weeklyTarget, dailyLimit, autoPause, categories } };
        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `arbeitszeit-backup-${new Date().toISOString().split('T')[0]}.json`;
        a.click();
      };

      const exportCSV = () => {
        const headers = ['Datum', 'Start', 'Ende', 'Stunden', 'Kategorie', 'Notiz'];
        const rows = entries.map(e => [
          e.date,
          e.startTime || '',
          e.endTime || '',
          e.hours.toFixed(2),
          e.category,
          e.note || ''
        ]);
        const csv = [headers, ...rows].map(r => r.map(c => `"${c}"`).join(';')).join('\n');
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `arbeitszeit-${new Date().toISOString().split('T')[0]}.csv`;
        a.click();
      };

      const importJSON = async (e) => {
        const file = e.target.files[0];
        if (!file) return;
        
        const text = await file.text();
        try {
          const data = JSON.parse(text);
          if (data.entries && Array.isArray(data.entries)) {
            const result = await api.importData(data);
            setEntries(result.entries);
            if (data.settings) {
              setWeeklyTarget(data.settings.weeklyTarget || 35);
              setDailyLimit(data.settings.dailyLimit || 8);
              setAutoPause(data.settings.autoPause || 0);
              if (data.settings.categories) {
                setCategories(data.settings.categories);
              }
            }
            alert(`✓ ${result.entries.length} Einträge importiert`);
          }
        } catch (err) {
          alert('Fehler beim Import: ' + err.message);
        }
        e.target.value = '';
      };

      // Get week number
      const getWeekNumber = (d) => {
        const date = new Date(d);
        date.setHours(0, 0, 0, 0);
        date.setDate(date.getDate() + 3 - (date.getDay() + 6) % 7);
        const week1 = new Date(date.getFullYear(), 0, 4);
        return Math.round(((date - week1) / 86400000 - 3 + (week1.getDay() + 6) % 7) / 7) + 1;
      };

      // Get Monday of a week
      const getMondayOfWeek = (d) => {
        const date = new Date(d);
        const day = date.getDay();
        const diff = date.getDate() - day + (day === 0 ? -6 : 1);
        return new Date(date.setDate(diff));
      };

      // Get stats for a date range
      const getStats = (startDate, endDate) => {
        return entries
          .filter(e => e.date >= startDate && e.date <= endDate)
          .reduce((sum, e) => sum + e.hours, 0);
      };

      // Get today's hours
      const getTodayHours = () => {
        const today = new Date().toISOString().split('T')[0];
        return getStats(today, today);
      };

      // Get this week's date range
      const getThisWeekRange = () => {
        const now = new Date();
        const monday = getMondayOfWeek(now);
        const sunday = new Date(monday);
        sunday.setDate(monday.getDate() + 6);
        return {
          start: monday.toISOString().split('T')[0],
          end: sunday.toISOString().split('T')[0]
        };
      };

      // Get this week's hours
      const getWeekHours = () => {
        const { start, end } = getThisWeekRange();
        return getStats(start, end);
      };

      // Get this month's hours
      const getMonthHours = () => {
        const now = new Date();
        const firstDay = new Date(now.getFullYear(), now.getMonth(), 1).toISOString().split('T')[0];
        const lastDay = new Date(now.getFullYear(), now.getMonth() + 1, 0).toISOString().split('T')[0];
        return getStats(firstDay, lastDay);
      };

      // Get remaining hours this week
      const getRemainingHours = () => {
        return Math.max(0, weeklyTarget - getWeekHours());
      };

      // Get last 8 weeks data for chart
      const getLast8WeeksData = () => {
        const weeks = [];
        const now = new Date();
        
        for (let i = 7; i >= 0; i--) {
          const weekStart = new Date(now);
          weekStart.setDate(now.getDate() - (i * 7) - (now.getDay() + 6) % 7);
          const weekEnd = new Date(weekStart);
          weekEnd.setDate(weekStart.getDate() + 6);
          
          const startStr = weekStart.toISOString().split('T')[0];
          const endStr = weekEnd.toISOString().split('T')[0];
          const weekHours = getStats(startStr, endStr);
          const weekNum = getWeekNumber(weekStart);
          
          weeks.push({
            week: `KW${weekNum}`,
            hours: weekHours,
            target: weeklyTarget,
            over: weekHours > weeklyTarget
          });
        }
        
        return weeks;
      };

      // Get entries grouped by week
      const getWeeklyReport = () => {
        const weeks = {};
        entries.forEach(e => {
          const weekNum = getWeekNumber(e.date);
          const year = new Date(e.date).getFullYear();
          const key = `${year}-W${weekNum.toString().padStart(2, '0')}`;
          if (!weeks[key]) weeks[key] = { hours: 0, entries: [] };
          weeks[key].hours += e.hours;
          weeks[key].entries.push(e);
        });
        return Object.entries(weeks).sort((a, b) => b[0].localeCompare(a[0]));
      };

      // Get entries grouped by month
      const getMonthlyReport = () => {
        const months = {};
        entries.forEach(e => {
          const key = e.date.substring(0, 7);
          if (!months[key]) months[key] = { hours: 0, entries: [] };
          months[key].hours += e.hours;
          months[key].entries.push(e);
        });
        return Object.entries(months).sort((a, b) => b[0].localeCompare(a[0]));
      };

      // Generate PDF for a month
      const generatePDF = (month, data) => {
        const monthName = new Date(month + '-01').toLocaleDateString('de-AT', { month: 'long', year: 'numeric' });
        const monthlyTarget = weeklyTarget * 4.33;
        const monthEntries = data.entries.sort((a, b) => a.date.localeCompare(b.date));
        
        const byCategory = {};
        monthEntries.forEach(e => {
          if (!byCategory[e.category]) byCategory[e.category] = 0;
          byCategory[e.category] += e.hours;
        });
        
        const htmlContent = `
          <!DOCTYPE html>
          <html>
          <head>
            <meta charset="UTF-8">
            <title>Arbeitszeit ${monthName}</title>
            <style>
              body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; padding: 40px; color: #1a1a1a; }
              h1 { font-weight: 300; font-size: 28px; margin-bottom: 8px; }
              .subtitle { color: #666; margin-bottom: 32px; }
              .summary { display: flex; gap: 40px; margin-bottom: 32px; padding: 20px; background: #f5f5f5; border-radius: 8px; }
              .summary-item { }
              .summary-label { font-size: 12px; color: #666; margin-bottom: 4px; }
              .summary-value { font-size: 24px; font-weight: 300; }
              .over { color: #ef4444; }
              .categories { margin-bottom: 32px; }
              .categories h2 { font-size: 14px; font-weight: 600; margin-bottom: 12px; }
              .category-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #eee; }
              table { width: 100%; border-collapse: collapse; font-size: 13px; }
              th { text-align: left; padding: 12px 8px; border-bottom: 2px solid #ddd; font-weight: 600; }
              td { padding: 10px 8px; border-bottom: 1px solid #eee; }
              .hours { text-align: right; font-variant-numeric: tabular-nums; }
              .note { color: #666; font-size: 12px; }
              @media print { body { padding: 20px; } }
            </style>
          </head>
          <body>
            <h1>Arbeitszeitnachweis</h1>
            <div class="subtitle">${monthName}</div>
            
            <div class="summary">
              <div class="summary-item">
                <div class="summary-label">Gesamt</div>
                <div class="summary-value ${data.hours > monthlyTarget ? 'over' : ''}">${data.hours.toFixed(1)}h</div>
              </div>
              <div class="summary-item">
                <div class="summary-label">Ziel (~${weeklyTarget}h × 4.33)</div>
                <div class="summary-value">${monthlyTarget.toFixed(0)}h</div>
              </div>
              <div class="summary-item">
                <div class="summary-label">Differenz</div>
                <div class="summary-value ${data.hours > monthlyTarget ? 'over' : ''}">${data.hours > monthlyTarget ? '+' : ''}${(data.hours - monthlyTarget).toFixed(1)}h</div>
              </div>
              <div class="summary-item">
                <div class="summary-label">Einträge</div>
                <div class="summary-value">${monthEntries.length}</div>
              </div>
            </div>
            
            <div class="categories">
              <h2>Nach Kategorie</h2>
              ${Object.entries(byCategory).map(([cat, hrs]) => `
                <div class="category-row">
                  <span>${cat}</span>
                  <span>${hrs.toFixed(1)}h</span>
                </div>
              `).join('')}
            </div>
            
            <table>
              <thead>
                <tr>
                  <th>Datum</th>
                  <th>Zeit</th>
                  <th>Kategorie</th>
                  <th>Notiz</th>
                  <th class="hours">Stunden</th>
                </tr>
              </thead>
              <tbody>
                ${monthEntries.map(e => `
                  <tr>
                    <td>${new Date(e.date).toLocaleDateString('de-AT', { weekday: 'short', day: '2-digit', month: '2-digit' })}</td>
                    <td>${e.startTime ? `${e.startTime}–${e.endTime}` : '–'}</td>
                    <td>${e.category}</td>
                    <td class="note">${e.note || '–'}</td>
                    <td class="hours">${e.hours.toFixed(2)}</td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </body>
          </html>
        `;
        
        const printWindow = window.open('', '_blank');
        printWindow.document.write(htmlContent);
        printWindow.document.close();
        printWindow.print();
      };

      const weekProgress = (getWeekHours() / weeklyTarget) * 100;
      const hoursRemaining = getRemainingHours();
      const chartData = getLast8WeeksData();

      if (loading) {
        return (
          <div className="min-h-screen bg-zinc-950 text-zinc-100 flex items-center justify-center">
            <div className="text-zinc-500">Laden...</div>
          </div>
        );
      }

      return (
        <div className="min-h-screen bg-zinc-950 text-zinc-100 p-4 md:p-8">
          <div className="max-w-2xl mx-auto">
            {/* Header */}
            <div className="flex justify-between items-start mb-6">
              <div>
                <h1 className="text-2xl font-light mb-1">Arbeitszeit</h1>
                <p className="text-zinc-500 text-sm">Ziel: {weeklyTarget}h / Woche</p>
              </div>
              <button
                onClick={() => { setShowSettings(!showSettings); setTempTarget(weeklyTarget); setTempDailyLimit(dailyLimit); setTempAutoPause(autoPause); }}
                className="p-2 text-zinc-500 hover:text-zinc-100 transition-colors"
              >
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                  <circle cx="12" cy="12" r="3"></circle>
                  <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
                </svg>
              </button>
            </div>

            {/* Settings Panel */}
            {showSettings && (
              <div className="bg-zinc-900 rounded-xl p-4 mb-6 space-y-4">
                <div className="grid grid-cols-3 gap-4">
                  <div>
                    <label className="text-zinc-400 text-xs block mb-2">Wochenziel (h)</label>
                    <input
                      type="number"
                      value={tempTarget}
                      onChange={e => setTempTarget(parseFloat(e.target.value) || 0)}
                      className="w-full bg-zinc-800 rounded-lg px-3 py-2 text-zinc-100 border-none outline-none"
                    />
                  </div>
                  <div>
                    <label className="text-zinc-400 text-xs block mb-2">Tageslimit (h)</label>
                    <input
                      type="number"
                      value={tempDailyLimit}
                      onChange={e => setTempDailyLimit(parseFloat(e.target.value) || 0)}
                      className="w-full bg-zinc-800 rounded-lg px-3 py-2 text-zinc-100 border-none outline-none"
                    />
                  </div>
                  <div>
                    <label className="text-zinc-400 text-xs block mb-2">Auto-Pause (min)</label>
                    <input
                      type="number"
                      value={tempAutoPause}
                      onChange={e => setTempAutoPause(parseInt(e.target.value) || 0)}
                      className="w-full bg-zinc-800 rounded-lg px-3 py-2 text-zinc-100 border-none outline-none"
                      placeholder="z.B. 30"
                    />
                  </div>
                </div>
                <div className="text-zinc-500 text-xs">
                  Auto-Pause: Wird bei &gt;6h automatisch abgezogen
                </div>
                
                {/* Category Management */}
                <div>
                  <label className="text-zinc-400 text-xs block mb-2">Kategorien</label>
                  <div className="flex flex-wrap gap-2">
                    {categories.map(cat => (
                      <div key={cat} className="flex items-center gap-1 bg-zinc-800 rounded-lg px-3 py-1.5">
                        <span className="text-sm">{cat}</span>
                        {categories.length > 1 && (
                          <button
                            onClick={() => deleteCategory(cat)}
                            className="text-zinc-600 hover:text-red-400 ml-1"
                          >
                            ×
                          </button>
                        )}
                      </div>
                    ))}
                  </div>
                </div>

                {/* Export/Import */}
                <div className="flex gap-2 pt-2 border-t border-zinc-800">
                  <button
                    onClick={exportJSON}
                    className="px-3 py-1.5 bg-zinc-800 rounded text-xs hover:bg-zinc-700"
                  >
                    JSON Export
                  </button>
                  <button
                    onClick={exportCSV}
                    className="px-3 py-1.5 bg-zinc-800 rounded text-xs hover:bg-zinc-700"
                  >
                    CSV Export
                  </button>
                  <button
                    onClick={() => fileInputRef.current?.click()}
                    className="px-3 py-1.5 bg-zinc-800 rounded text-xs hover:bg-zinc-700"
                  >
                    JSON Import
                  </button>
                  <input
                    ref={fileInputRef}
                    type="file"
                    accept=".json"
                    onChange={importJSON}
                    className="hidden"
                  />
                </div>
                
                <div className="flex justify-end gap-2 pt-2">
                  <button
                    onClick={() => setShowSettings(false)}
                    className="px-4 py-2 text-zinc-500 hover:text-zinc-100"
                  >
                    Abbrechen
                  </button>
                  <button
                    onClick={saveSettings}
                    className="px-4 py-2 bg-zinc-100 text-zinc-900 rounded-lg"
                  >
                    Speichern
                  </button>
                </div>
              </div>
            )}

            {/* Hours Remaining */}
            <div className="bg-gradient-to-r from-zinc-900 to-zinc-800 rounded-xl p-6 mb-6">
              <div className="text-zinc-400 text-sm mb-1">Diese Woche noch frei</div>
              <div className={`text-4xl font-light ${hoursRemaining === 0 ? 'text-amber-400' : 'text-emerald-400'}`}>
                {hoursRemaining.toFixed(1)}h
              </div>
              {getWeekHours() > weeklyTarget && (
                <div className="text-red-400 text-sm mt-2">
                  ⚠️ {(getWeekHours() - weeklyTarget).toFixed(1)}h über dem Ziel
                </div>
              )}
            </div>

            {/* Quick Stats */}
            <div className="grid grid-cols-3 gap-4 mb-6">
              <div className="bg-zinc-900 rounded-xl p-4">
                <div className="text-zinc-500 text-xs mb-1">Heute</div>
                <div className={`text-2xl font-light ${getTodayHours() > dailyLimit ? 'text-red-400' : ''}`}>
                  {getTodayHours().toFixed(1)}h
                </div>
              </div>
              <div className="bg-zinc-900 rounded-xl p-4">
                <div className="text-zinc-500 text-xs mb-1">Diese Woche</div>
                <div className={`text-2xl font-light ${getWeekHours() > weeklyTarget ? 'text-red-400' : ''}`}>
                  {getWeekHours().toFixed(1)}h
                </div>
              </div>
              <div className="bg-zinc-900 rounded-xl p-4">
                <div className="text-zinc-500 text-xs mb-1">Dieser Monat</div>
                <div className="text-2xl font-light">{getMonthHours().toFixed(1)}h</div>
              </div>
            </div>

            {/* Week Progress Bar */}
            <div className="mb-8">
              <div className="flex justify-between text-xs text-zinc-500 mb-2">
                <span>Wochenziel</span>
                <span>{getWeekHours().toFixed(1)} / {weeklyTarget}h</span>
              </div>
              <div className="h-2 bg-zinc-800 rounded-full overflow-hidden">
                <div 
                  className={`h-full transition-all duration-500 ${weekProgress > 100 ? 'bg-red-500' : weekProgress > 85 ? 'bg-amber-500' : 'bg-emerald-500'}`}
                  style={{ width: `${Math.min(weekProgress, 100)}%` }}
                />
              </div>
            </div>

            {/* Navigation */}
            <div className="flex gap-2 mb-6 overflow-x-auto pb-2">
              {['entry', 'trend', 'history', 'weekly', 'monthly'].map(v => (
                <button
                  key={v}
                  onClick={() => setView(v)}
                  className={`px-4 py-2 rounded-lg text-sm transition-colors whitespace-nowrap ${
                    view === v 
                      ? 'bg-zinc-100 text-zinc-900' 
                      : 'bg-zinc-900 text-zinc-400 hover:text-zinc-100'
                  }`}
                >
                  {v === 'entry' ? 'Erfassen' : v === 'trend' ? 'Trend' : v === 'history' ? 'Einträge' : v === 'weekly' ? 'Wochen' : 'Monate'}
                </button>
              ))}
            </div>

            {/* Entry Form */}
            {view === 'entry' && (
              <div className="bg-zinc-900 rounded-xl p-6">
                {/* Presets */}
                <div className="flex gap-2 mb-4">
                  <button
                    onClick={() => applyPreset('8-15')}
                    className="px-3 py-1.5 bg-zinc-800 rounded-lg text-xs text-zinc-400 hover:text-zinc-100 hover:bg-zinc-700"
                  >
                    8–15 Uhr
                  </button>
                  <button
                    onClick={() => applyPreset('8-12')}
                    className="px-3 py-1.5 bg-zinc-800 rounded-lg text-xs text-zinc-400 hover:text-zinc-100 hover:bg-zinc-700"
                  >
                    8–12 Uhr
                  </button>
                  <button
                    onClick={() => applyPreset('yesterday')}
                    className="px-3 py-1.5 bg-zinc-800 rounded-lg text-xs text-zinc-400 hover:text-zinc-100 hover:bg-zinc-700"
                  >
                    Wie gestern
                  </button>
                </div>

                {/* Mode Toggle */}
                <div className="flex gap-2 mb-6">
                  <button
                    onClick={() => setEntryMode('range')}
                    className={`flex-1 py-2 rounded-lg text-sm transition-colors ${
                      entryMode === 'range' ? 'bg-zinc-700' : 'bg-zinc-800 text-zinc-500'
                    }`}
                  >
                    Von – Bis
                  </button>
                  <button
                    onClick={() => setEntryMode('hours')}
                    className={`flex-1 py-2 rounded-lg text-sm transition-colors ${
                      entryMode === 'hours' ? 'bg-zinc-700' : 'bg-zinc-800 text-zinc-500'
                    }`}
                  >
                    Stunden direkt
                  </button>
                </div>

                {/* Date */}
                <div className="mb-4">
                  <label className="text-zinc-500 text-xs block mb-2">Datum</label>
                  <input
                    type="date"
                    value={date}
                    onChange={e => setDate(e.target.value)}
                    className="w-full bg-zinc-800 rounded-lg px-4 py-3 text-zinc-100 border-none outline-none focus:ring-2 focus:ring-zinc-600"
                  />
                </div>

                {/* Time Input */}
                {entryMode === 'range' ? (
                  <div className="grid grid-cols-2 gap-4 mb-4">
                    <div>
                      <label className="text-zinc-500 text-xs block mb-2">Von</label>
                      <input
                        type="time"
                        value={startTime}
                        onChange={e => setStartTime(e.target.value)}
                        className="w-full bg-zinc-800 rounded-lg px-4 py-3 text-zinc-100 border-none outline-none focus:ring-2 focus:ring-zinc-600"
                      />
                    </div>
                    <div>
                      <label className="text-zinc-500 text-xs block mb-2">Bis</label>
                      <input
                        type="time"
                        value={endTime}
                        onChange={e => setEndTime(e.target.value)}
                        className="w-full bg-zinc-800 rounded-lg px-4 py-3 text-zinc-100 border-none outline-none focus:ring-2 focus:ring-zinc-600"
                      />
                    </div>
                  </div>
                ) : (
                  <div className="mb-4">
                    <label className="text-zinc-500 text-xs block mb-2">Stunden</label>
                    <input
                      type="number"
                      step="0.25"
                      value={hours}
                      onChange={e => setHours(e.target.value)}
                      placeholder="z.B. 7.5"
                      className="w-full bg-zinc-800 rounded-lg px-4 py-3 text-zinc-100 border-none outline-none focus:ring-2 focus:ring-zinc-600 placeholder-zinc-600"
                    />
                  </div>
                )}

                {/* Preview */}
                {entryMode === 'range' && startTime && endTime && (
                  <div className="text-center text-zinc-500 text-sm mb-4">
                    = {calculateHours(startTime, endTime, true).toFixed(2)} Stunden
                    {autoPause > 0 && calculateHours(startTime, endTime) > 6 && (
                      <span className="text-zinc-600"> (inkl. -{autoPause}min Pause)</span>
                    )}
                  </div>
                )}

                {/* Category */}
                <div className="mb-4">
                  <label className="text-zinc-500 text-xs block mb-2">Kategorie</label>
                  <div className="flex flex-wrap gap-2">
                    {categories.map(cat => (
                      <button
                        key={cat}
                        onClick={() => setCategory(cat)}
                        className={`px-3 py-1.5 rounded-lg text-sm transition-colors ${
                          category === cat 
                            ? 'bg-zinc-100 text-zinc-900' 
                            : 'bg-zinc-800 text-zinc-400 hover:text-zinc-100'
                        }`}
                      >
                        {cat}
                      </button>
                    ))}
                    <button
                      onClick={() => setShowAddCategory(!showAddCategory)}
                      className="px-3 py-1.5 rounded-lg text-sm bg-zinc-800 text-zinc-500 hover:text-zinc-100"
                    >
                      +
                    </button>
                  </div>
                  {showAddCategory && (
                    <div className="flex gap-2 mt-3">
                      <input
                        type="text"
                        value={newCategory}
                        onChange={e => setNewCategory(e.target.value)}
                        placeholder="Neue Kategorie"
                        className="flex-1 bg-zinc-800 rounded-lg px-4 py-2 text-sm text-zinc-100 border-none outline-none"
                      />
                      <button
                        onClick={addCategory}
                        className="px-4 py-2 bg-zinc-700 rounded-lg text-sm hover:bg-zinc-600"
                      >
                        Hinzufügen
                      </button>
                    </div>
                  )}
                </div>

                {/* Note */}
                <div className="mb-6">
                  <label className="text-zinc-500 text-xs block mb-2">Notiz (optional)</label>
                  <input
                    type="text"
                    value={note}
                    onChange={e => setNote(e.target.value)}
                    placeholder="Was hast du gemacht?"
                    className="w-full bg-zinc-800 rounded-lg px-4 py-3 text-zinc-100 border-none outline-none focus:ring-2 focus:ring-zinc-600 placeholder-zinc-600"
                  />
                </div>

                {/* Submit */}
                <button
                  onClick={addEntry}
                  className="w-full bg-zinc-100 text-zinc-900 rounded-lg py-3 font-medium hover:bg-white transition-colors"
                >
                  Eintragen
                </button>
              </div>
            )}

            {/* 8-Week Trend Chart */}
            {view === 'trend' && (
              <div className="bg-zinc-900 rounded-xl p-6">
                <h2 className="text-zinc-400 text-sm mb-4">Letzte 8 Wochen</h2>
                <div className="h-64">
                  <ResponsiveContainer width="100%" height="100%">
                    <BarChart data={chartData} margin={{ top: 20, right: 10, left: -20, bottom: 5 }}>
                      <XAxis 
                        dataKey="week" 
                        axisLine={false}
                        tickLine={false}
                        tick={{ fill: '#71717a', fontSize: 12 }}
                      />
                      <YAxis 
                        axisLine={false}
                        tickLine={false}
                        tick={{ fill: '#71717a', fontSize: 12 }}
                      />
                      <ReferenceLine 
                        y={weeklyTarget} 
                        stroke="#ef4444" 
                        strokeDasharray="4 4"
                        label={{ value: `${weeklyTarget}h`, fill: '#ef4444', fontSize: 11, position: 'right' }}
                      />
                      <Bar dataKey="hours" radius={[4, 4, 0, 0]}>
                        {chartData.map((entry, index) => (
                          <Cell 
                            key={`cell-${index}`} 
                            fill={entry.over ? '#ef4444' : '#10b981'}
                          />
                        ))}
                      </Bar>
                    </BarChart>
                  </ResponsiveContainer>
                </div>
                <div className="flex justify-center gap-6 mt-4 text-xs text-zinc-500">
                  <div className="flex items-center gap-2">
                    <div className="w-3 h-3 rounded bg-emerald-500"></div>
                    <span>Unter Ziel</span>
                  </div>
                  <div className="flex items-center gap-2">
                    <div className="w-3 h-3 rounded bg-red-500"></div>
                    <span>Über Ziel</span>
                  </div>
                </div>
              </div>
            )}

            {/* History with Edit */}
            {view === 'history' && (
              <div className="space-y-2">
                {entries.length === 0 ? (
                  <div className="text-zinc-500 text-center py-8">Noch keine Einträge</div>
                ) : (
                  [...entries].reverse().map(entry => (
                    <div key={entry.id} className="bg-zinc-900 rounded-xl p-4">
                      {editingEntry === entry.id ? (
                        <div className="space-y-4">
                          <div className="flex gap-2 mb-4">
                            <button
                              onClick={() => setEditMode('range')}
                              className={`flex-1 py-1.5 rounded text-xs ${editMode === 'range' ? 'bg-zinc-700' : 'bg-zinc-800 text-zinc-500'}`}
                            >
                              Von–Bis
                            </button>
                            <button
                              onClick={() => setEditMode('hours')}
                              className={`flex-1 py-1.5 rounded text-xs ${editMode === 'hours' ? 'bg-zinc-700' : 'bg-zinc-800 text-zinc-500'}`}
                            >
                              Stunden
                            </button>
                          </div>
                          
                          <input
                            type="date"
                            value={editDate}
                            onChange={e => setEditDate(e.target.value)}
                            className="w-full bg-zinc-800 rounded px-3 py-2 text-sm"
                          />
                          
                          {editMode === 'range' ? (
                            <div className="grid grid-cols-2 gap-2">
                              <input
                                type="time"
                                value={editStartTime}
                                onChange={e => setEditStartTime(e.target.value)}
                                className="bg-zinc-800 rounded px-3 py-2 text-sm"
                              />
                              <input
                                type="time"
                                value={editEndTime}
                                onChange={e => setEditEndTime(e.target.value)}
                                className="bg-zinc-800 rounded px-3 py-2 text-sm"
                              />
                            </div>
                          ) : (
                            <input
                              type="number"
                              step="0.25"
                              value={editHours}
                              onChange={e => setEditHours(e.target.value)}
                              className="w-full bg-zinc-800 rounded px-3 py-2 text-sm"
                              placeholder="Stunden"
                            />
                          )}
                          
                          <select
                            value={editCategory}
                            onChange={e => setEditCategory(e.target.value)}
                            className="w-full bg-zinc-800 rounded px-3 py-2 text-sm"
                          >
                            {categories.map(cat => (
                              <option key={cat} value={cat}>{cat}</option>
                            ))}
                          </select>
                          
                          <input
                            type="text"
                            value={editNote}
                            onChange={e => setEditNote(e.target.value)}
                            className="w-full bg-zinc-800 rounded px-3 py-2 text-sm"
                            placeholder="Notiz"
                          />
                          
                          <div className="flex gap-2">
                            <button
                              onClick={cancelEdit}
                              className="flex-1 py-2 text-zinc-500 hover:text-zinc-100 text-sm"
                            >
                              Abbrechen
                            </button>
                            <button
                              onClick={saveEdit}
                              className="flex-1 py-2 bg-zinc-100 text-zinc-900 rounded text-sm"
                            >
                              Speichern
                            </button>
                          </div>
                        </div>
                      ) : (
                        <div className="flex items-center justify-between">
                          <div className="flex-1" onClick={() => startEdit(entry)} style={{ cursor: 'pointer' }}>
                            <div className="flex items-center gap-3">
                              <span className="text-lg font-light">{entry.hours.toFixed(1)}h</span>
                              <span className="text-zinc-500 text-sm">{entry.category}</span>
                            </div>
                            <div className="text-zinc-500 text-xs mt-1">
                              {new Date(entry.date).toLocaleDateString('de-AT', { weekday: 'short', day: 'numeric', month: 'short' })}
                              {entry.startTime && ` · ${entry.startTime}–${entry.endTime}`}
                              {entry.note && ` · ${entry.note}`}
                            </div>
                          </div>
                          <div className="flex items-center gap-1">
                            <button
                              onClick={() => startEdit(entry)}
                              className="text-zinc-600 hover:text-zinc-100 transition-colors p-2"
                              title="Bearbeiten"
                            >
                              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                                <path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path>
                              </svg>
                            </button>
                            <button
                              onClick={() => deleteEntry(entry.id)}
                              className="text-zinc-600 hover:text-red-400 transition-colors p-2"
                              title="Löschen"
                            >
                              ✕
                            </button>
                          </div>
                        </div>
                      )}
                    </div>
                  ))
                )}
              </div>
            )}

            {/* Weekly Report */}
            {view === 'weekly' && (
              <div className="space-y-3">
                {getWeeklyReport().length === 0 ? (
                  <div className="text-zinc-500 text-center py-8">Noch keine Daten</div>
                ) : (
                  getWeeklyReport().map(([week, data]) => (
                    <div key={week} className="bg-zinc-900 rounded-xl p-4">
                      <div className="flex justify-between items-center">
                        <span className="text-zinc-400">{week}</span>
                        <span className={`text-xl font-light ${data.hours > weeklyTarget ? 'text-red-400' : ''}`}>
                          {data.hours.toFixed(1)}h
                        </span>
                      </div>
                      <div className="mt-2 h-1.5 bg-zinc-800 rounded-full overflow-hidden">
                        <div 
                          className={`h-full ${data.hours > weeklyTarget ? 'bg-red-500' : 'bg-emerald-500'}`}
                          style={{ width: `${Math.min((data.hours / weeklyTarget) * 100, 100)}%` }}
                        />
                      </div>
                      {data.hours > weeklyTarget && (
                        <div className="text-red-400 text-xs mt-2">
                          +{(data.hours - weeklyTarget).toFixed(1)}h über Ziel
                        </div>
                      )}
                    </div>
                  ))
                )}
              </div>
            )}

            {/* Monthly Report with PDF Export */}
            {view === 'monthly' && (
              <div className="space-y-3">
                {getMonthlyReport().length === 0 ? (
                  <div className="text-zinc-500 text-center py-8">Noch keine Daten</div>
                ) : (
                  getMonthlyReport().map(([month, data]) => {
                    const monthlyTarget = weeklyTarget * 4.33;
                    return (
                      <div key={month} className="bg-zinc-900 rounded-xl p-4">
                        <div className="flex justify-between items-center">
                          <div>
                            <span className="text-zinc-100">
                              {new Date(month + '-01').toLocaleDateString('de-AT', { month: 'long', year: 'numeric' })}
                            </span>
                            <div className="text-zinc-600 text-xs mt-1">
                              Ziel: ~{monthlyTarget.toFixed(0)}h · {data.entries.length} Einträge
                            </div>
                          </div>
                          <div className="flex items-center gap-3">
                            <span className={`text-xl font-light ${data.hours > monthlyTarget ? 'text-red-400' : ''}`}>
                              {data.hours.toFixed(1)}h
                            </span>
                            <button
                              onClick={() => generatePDF(month, data)}
                              className="p-2 text-zinc-500 hover:text-zinc-100 transition-colors"
                              title="PDF exportieren"
                            >
                              <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                <polyline points="7,10 12,15 17,10"></polyline>
                                <line x1="12" y1="15" x2="12" y2="3"></line>
                              </svg>
                            </button>
                          </div>
                        </div>
                      </div>
                    );
                  })
                )}
              </div>
            )}

            {/* Footer */}
            <div className="mt-8 text-center text-zinc-700 text-xs">
              Worktime Tracker v1.0
            </div>
          </div>
        </div>
      );
    };

    ReactDOM.createRoot(document.getElementById('root')).render(<WorktimeTracker />);
  </script>
</body>
</html>
