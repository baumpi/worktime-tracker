<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Arbeitszeit Tracker</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { background: #09090b; color: #fafafa; font-family: system-ui, -apple-system, sans-serif; }
    input, select { background: #27272a; border: none; border-radius: 0.5rem; padding: 0.75rem 1rem; color: #fafafa; outline: none; }
    input:focus { box-shadow: 0 0 0 2px #52525b; }
    input[type="date"]::-webkit-calendar-picker-indicator,
    input[type="time"]::-webkit-calendar-picker-indicator { filter: invert(1); }
    button { cursor: pointer; transition: all 0.2s; }
    .card { background: #18181b; border-radius: 0.75rem; padding: 1rem; }
  </style>
</head>
<body>
  <div id="app" class="min-h-screen p-4 md:p-8">
    <div class="max-w-2xl mx-auto">
      <div class="text-center py-8 text-zinc-500">Laden...</div>
    </div>
  </div>

  <script>
    var state = {
      entries: [],
      categories: ['Arbeit', 'W2Learn', 'Voice', 'Institut', 'Admin'],
      weeklyTarget: 35,
      dailyLimit: 8,
      autoPause: 0,
      view: 'entry',
      trendView: 'weeks',
      showSettings: false,
      entryMode: 'range',
      date: new Date().toISOString().split('T')[0],
      startTime: '08:00',
      endTime: '15:00',
      hours: '',
      category: 'Arbeit',
      note: ''
    };

    var API = '/api';

    async function loadData() {
      try {
        var res = await fetch(API + '/entries');
        state.entries = await res.json();
        
        var settingsRes = await fetch(API + '/settings');
        var settings = await settingsRes.json();
        if (settings.weeklyTarget) state.weeklyTarget = settings.weeklyTarget;
        if (settings.dailyLimit) state.dailyLimit = settings.dailyLimit;
        if (settings.autoPause) state.autoPause = settings.autoPause;
        if (settings.categories) state.categories = settings.categories;
      } catch (e) {
        console.error('Load error:', e);
      }
      render();
    }

    async function saveEntry() {
      var hrs = state.entryMode === 'range' 
        ? calculateHours(state.startTime, state.endTime, true)
        : parseFloat(state.hours);
      
      if (!hrs || hrs <= 0) return;

      var entry = {
        date: state.date,
        hours: hrs,
        category: state.category,
        note: state.note,
        startTime: state.entryMode === 'range' ? state.startTime : null,
        endTime: state.entryMode === 'range' ? state.endTime : null
      };

      var res = await fetch(API + '/entries', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(entry)
      });
      var saved = await res.json();
      state.entries.push(saved);
      state.hours = '';
      state.note = '';
      render();
    }

    async function deleteEntry(id) {
      await fetch(API + '/entries/' + id, { method: 'DELETE' });
      state.entries = state.entries.filter(function(e) { return e.id !== id; });
      render();
    }

    async function saveSettings() {
      await fetch(API + '/settings', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          weeklyTarget: state.weeklyTarget,
          dailyLimit: state.dailyLimit,
          autoPause: state.autoPause,
          categories: state.categories
        })
      });
      state.showSettings = false;
      render();
    }

    function calculateHours(start, end, withPause) {
      if (!start || !end) return 0;
      var s = start.split(':').map(Number);
      var e = end.split(':').map(Number);
      var hrs = ((e[0] * 60 + e[1]) - (s[0] * 60 + s[1])) / 60;
      if (withPause && state.autoPause > 0 && hrs > 6) {
        hrs -= state.autoPause / 60;
      }
      return Math.max(0, hrs);
    }

    function getStats(startDate, endDate) {
      return state.entries
        .filter(function(e) { return e.date >= startDate && e.date <= endDate; })
        .reduce(function(sum, e) { return sum + e.hours; }, 0);
    }

    function getTodayHours() {
      var today = new Date().toISOString().split('T')[0];
      return getStats(today, today);
    }

    function getWeekHours() {
      var now = new Date();
      var day = now.getDay();
      var monday = new Date(now);
      monday.setDate(now.getDate() - (day === 0 ? 6 : day - 1));
      var sunday = new Date(monday);
      sunday.setDate(monday.getDate() + 6);
      return getStats(monday.toISOString().split('T')[0], sunday.toISOString().split('T')[0]);
    }

    function getMonthHours() {
      var now = new Date();
      var first = new Date(now.getFullYear(), now.getMonth(), 1).toISOString().split('T')[0];
      var last = new Date(now.getFullYear(), now.getMonth() + 1, 0).toISOString().split('T')[0];
      return getStats(first, last);
    }

    function getWeekNumber(d) {
      var date = new Date(d);
      date.setHours(0, 0, 0, 0);
      date.setDate(date.getDate() + 3 - (date.getDay() + 6) % 7);
      var week1 = new Date(date.getFullYear(), 0, 4);
      return Math.round(((date - week1) / 86400000 - 3 + (week1.getDay() + 6) % 7) / 7) + 1;
    }

    function getTrendAverage(data) {
      if (data.length === 0) return 0;
      var total = data.reduce(function(sum, item) { return sum + item.hours; }, 0);
      return total / data.length;
    }

    function getLast8WeeksData() {
      var weeks = [];
      var now = new Date();
      for (var i = 7; i >= 0; i--) {
        var weekStart = new Date(now);
        weekStart.setDate(now.getDate() - (i * 7) - (now.getDay() + 6) % 7);
        var weekEnd = new Date(weekStart);
        weekEnd.setDate(weekStart.getDate() + 6);
        var startStr = weekStart.toISOString().split('T')[0];
        var endStr = weekEnd.toISOString().split('T')[0];
        var weekHours = getStats(startStr, endStr);
        var weekNum = getWeekNumber(weekStart);
        weeks.push({ week: 'KW' + weekNum, hours: weekHours, over: weekHours > state.weeklyTarget });
      }
      return weeks;
    }

    function getLast6MonthsData() {
      var months = [];
      var now = new Date();
      var monthlyTarget = state.weeklyTarget * 4.33;

      for (var i = 5; i >= 0; i--) {
        var monthDate = new Date(now.getFullYear(), now.getMonth() - i, 1);
        var monthKey = monthDate.toISOString().substring(0, 7);
        var monthStart = monthKey + '-01';
        var monthEnd = new Date(monthDate.getFullYear(), monthDate.getMonth() + 1, 0).toISOString().split('T')[0];

        var monthHours = getStats(monthStart, monthEnd);
        var monthName = monthDate.toLocaleDateString('de-AT', { month: 'short', year: '2-digit' });

        months.push({
          month: monthName,
          hours: monthHours,
          over: monthHours > monthlyTarget
        });
      }
      return months;
    }

    function getWeeklyReport() {
      var weeks = {};
      state.entries.forEach(function(e) {
        var weekNum = getWeekNumber(e.date);
        var year = new Date(e.date).getFullYear();
        var key = year + '-W' + (weekNum < 10 ? '0' : '') + weekNum;
        if (!weeks[key]) weeks[key] = { hours: 0, entries: [] };
        weeks[key].hours += e.hours;
        weeks[key].entries.push(e);
      });
      return Object.entries(weeks).sort(function(a, b) { return b[0].localeCompare(a[0]); });
    }

    function getMonthlyReport() {
      var months = {};
      state.entries.forEach(function(e) {
        var key = e.date.substring(0, 7);
        if (!months[key]) months[key] = { hours: 0, entries: [] };
        months[key].hours += e.hours;
        months[key].entries.push(e);
      });
      return Object.entries(months).sort(function(a, b) { return b[0].localeCompare(a[0]); });
    }

    function formatDate(dateStr) {
      return new Date(dateStr).toLocaleDateString('de-AT', { weekday: 'short', day: 'numeric', month: 'short' });
    }

    function setView(v) { state.view = v; render(); }
    function setTrendView(v) { state.trendView = v; render(); }
    function setEntryMode(m) { state.entryMode = m; render(); }
    function setCategory(c) { state.category = c; render(); }
    function setPreset(start, end) { state.startTime = start; state.endTime = end; state.entryMode = 'range'; render(); }
    function toggleSettings() { state.showSettings = !state.showSettings; render(); }
    function updateDate(v) { state.date = v; }
    function updateStartTime(v) { state.startTime = v; render(); }
    function updateEndTime(v) { state.endTime = v; render(); }
    function updateHours(v) { state.hours = v; }
    function updateNote(v) { state.note = v; }
    function updateWeeklyTarget(v) { state.weeklyTarget = parseFloat(v) || 35; }
    function updateDailyLimit(v) { state.dailyLimit = parseFloat(v) || 8; }
    function updateAutoPause(v) { state.autoPause = parseInt(v) || 0; }

    function exportMonthlyCSV(month, entries) {
      var headers = ['Datum', 'Start', 'Ende', 'Stunden', 'Kategorie', 'Notiz'];
      var sortedEntries = entries.sort(function(a, b) { return a.date.localeCompare(b.date); });
      var rows = sortedEntries.map(function(e) {
        return [e.date, e.startTime || '', e.endTime || '', e.hours.toFixed(2), e.category, e.note || ''];
      });
      var allRows = [headers].concat(rows);
      var csv = allRows.map(function(r) {
        return r.map(function(c) { return '"' + c + '"'; }).join(';');
      }).join('\n');
      var blob = new Blob([csv], { type: 'text/csv;charset=utf-8' });
      var url = URL.createObjectURL(blob);
      var a = document.createElement('a');
      a.href = url;
      a.download = 'arbeitszeit-' + month + '.csv';
      a.click();
    }

    function generatePDF(month, data) {
      var monthName = new Date(month + '-01').toLocaleDateString('de-AT', { month: 'long', year: 'numeric' });
      var monthlyTarget = state.weeklyTarget * 4.33;
      var monthEntries = data.entries.sort(function(a, b) { return a.date.localeCompare(b.date); });
      var byCategory = {};
      monthEntries.forEach(function(e) {
        if (!byCategory[e.category]) byCategory[e.category] = 0;
        byCategory[e.category] += e.hours;
      });

      var catHtml = Object.entries(byCategory).map(function(item) {
        return '<div class="category-row"><span>' + item[0] + '</span><span>' + item[1].toFixed(1) + 'h</span></div>';
      }).join('');

      var entriesHtml = monthEntries.map(function(e) {
        var dateStr = new Date(e.date).toLocaleDateString('de-AT', { weekday: 'short', day: '2-digit', month: '2-digit' });
        var timeStr = e.startTime ? e.startTime + '–' + e.endTime : '–';
        return '<tr><td>' + dateStr + '</td><td>' + timeStr + '</td><td>' + e.category + '</td><td class="note">' + (e.note || '–') + '</td><td class="hours">' + e.hours.toFixed(2) + '</td></tr>';
      }).join('');

      var htmlContent = '<!DOCTYPE html><html><head><meta charset="UTF-8"><title>Arbeitszeit ' + monthName + '</title><style>body{font-family:-apple-system,BlinkMacSystemFont,sans-serif;padding:40px;color:#1a1a1a}h1{font-weight:300;font-size:28px;margin-bottom:8px}.subtitle{color:#666;margin-bottom:32px}.summary{display:flex;gap:40px;margin-bottom:32px;padding:20px;background:#f5f5f5;border-radius:8px}.summary-label{font-size:12px;color:#666;margin-bottom:4px}.summary-value{font-size:24px;font-weight:300}.over{color:#ef4444}.categories{margin-bottom:32px}.categories h2{font-size:14px;font-weight:600;margin-bottom:12px}.category-row{display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid #eee}table{width:100%;border-collapse:collapse;font-size:13px}th{text-align:left;padding:12px 8px;border-bottom:2px solid #ddd;font-weight:600}td{padding:10px 8px;border-bottom:1px solid #eee}.hours{text-align:right}.note{color:#666;font-size:12px}</style></head><body><h1>Arbeitszeitnachweis</h1><div class="subtitle">' + monthName + '</div><div class="summary"><div><div class="summary-label">Gesamt</div><div class="summary-value ' + (data.hours > monthlyTarget ? 'over' : '') + '">' + data.hours.toFixed(1) + 'h</div></div><div><div class="summary-label">Ziel</div><div class="summary-value">' + monthlyTarget.toFixed(0) + 'h</div></div><div><div class="summary-label">Differenz</div><div class="summary-value ' + (data.hours > monthlyTarget ? 'over' : '') + '">' + (data.hours - monthlyTarget).toFixed(1) + 'h</div></div></div><div class="categories"><h2>Nach Kategorie</h2>' + catHtml + '</div><table><thead><tr><th>Datum</th><th>Zeit</th><th>Kategorie</th><th>Notiz</th><th class="hours">Stunden</th></tr></thead><tbody>' + entriesHtml + '</tbody></table></body></html>';

      var printWindow = window.open('', '_blank');
      printWindow.document.write(htmlContent);
      printWindow.document.close();
      printWindow.print();
    }

    function render() {
      var weekHours = getWeekHours();
      var remaining = Math.max(0, state.weeklyTarget - weekHours);
      var progress = (weekHours / state.weeklyTarget) * 100;
      var progressColor = progress > 100 ? 'bg-red-500' : progress > 85 ? 'bg-amber-500' : 'bg-emerald-500';

      var html = '<div class="max-w-2xl mx-auto">';
      
      html += '<div class="flex justify-between items-start mb-6">';
      html += '<div><h1 class="text-2xl font-light mb-1">Arbeitszeit</h1>';
      html += '<p class="text-zinc-500 text-sm">Ziel: ' + state.weeklyTarget + 'h / Woche</p></div>';
      html += '<button onclick="toggleSettings()" class="p-2 text-zinc-500 hover:text-zinc-100 text-xl">⚙️</button>';
      html += '</div>';

      if (state.showSettings) {
        html += '<div class="card mb-6 space-y-4">';
        html += '<div class="grid grid-cols-3 gap-4">';
        html += '<div><label class="text-zinc-400 text-xs block mb-2">Wochenziel (h)</label>';
        html += '<input type="number" value="' + state.weeklyTarget + '" onchange="updateWeeklyTarget(this.value)" class="w-full"></div>';
        html += '<div><label class="text-zinc-400 text-xs block mb-2">Tageslimit (h)</label>';
        html += '<input type="number" value="' + state.dailyLimit + '" onchange="updateDailyLimit(this.value)" class="w-full"></div>';
        html += '<div><label class="text-zinc-400 text-xs block mb-2">Auto-Pause (min)</label>';
        html += '<input type="number" value="' + state.autoPause + '" onchange="updateAutoPause(this.value)" class="w-full"></div>';
        html += '</div>';
        html += '<div class="flex gap-2 justify-end">';
        html += '<button onclick="toggleSettings()" class="px-4 py-2 text-zinc-500 hover:text-zinc-100">Abbrechen</button>';
        html += '<button onclick="saveSettings()" class="px-4 py-2 bg-zinc-100 text-zinc-900 rounded-lg hover:bg-white">Speichern</button>';
        html += '</div></div>';
      }

      html += '<div class="card mb-6 bg-gradient-to-r from-zinc-900 to-zinc-800 p-6">';
      html += '<div class="text-zinc-400 text-sm mb-1">Diese Woche noch frei</div>';
      var remainingColor = remaining === 0 ? 'text-amber-400' : 'text-emerald-400';
      html += '<div class="text-4xl font-light ' + remainingColor + '">' + remaining.toFixed(1) + 'h</div>';
      if (weekHours > state.weeklyTarget) {
        html += '<div class="text-red-400 text-sm mt-2">⚠️ ' + (weekHours - state.weeklyTarget).toFixed(1) + 'h über dem Ziel</div>';
      }
      html += '</div>';

      html += '<div class="grid grid-cols-3 gap-4 mb-6">';
      html += '<div class="card"><div class="text-zinc-500 text-xs mb-1">Heute</div>';
      html += '<div class="text-2xl font-light">' + getTodayHours().toFixed(1) + 'h</div></div>';
      html += '<div class="card"><div class="text-zinc-500 text-xs mb-1">Diese Woche</div>';
      var weekColor = weekHours > state.weeklyTarget ? 'text-red-400' : '';
      html += '<div class="text-2xl font-light ' + weekColor + '">' + weekHours.toFixed(1) + 'h</div></div>';
      html += '<div class="card"><div class="text-zinc-500 text-xs mb-1">Dieser Monat</div>';
      html += '<div class="text-2xl font-light">' + getMonthHours().toFixed(1) + 'h</div></div>';
      html += '</div>';

      html += '<div class="mb-8">';
      html += '<div class="flex justify-between text-xs text-zinc-500 mb-2"><span>Wochenziel</span><span>' + weekHours.toFixed(1) + ' / ' + state.weeklyTarget + 'h</span></div>';
      html += '<div class="h-2 bg-zinc-800 rounded-full overflow-hidden">';
      html += '<div class="h-full transition-all duration-500 ' + progressColor + '" style="width:' + Math.min(progress, 100) + '%"></div>';
      html += '</div></div>';

      html += '<div class="flex gap-2 mb-6 overflow-x-auto">';
      var entryActive = state.view === 'entry' ? 'bg-zinc-100 text-zinc-900' : 'bg-zinc-900 text-zinc-400 hover:text-zinc-100';
      var trendActive = state.view === 'trend' ? 'bg-zinc-100 text-zinc-900' : 'bg-zinc-900 text-zinc-400 hover:text-zinc-100';
      var historyActive = state.view === 'history' ? 'bg-zinc-100 text-zinc-900' : 'bg-zinc-900 text-zinc-400 hover:text-zinc-100';
      var weeklyActive = state.view === 'weekly' ? 'bg-zinc-100 text-zinc-900' : 'bg-zinc-900 text-zinc-400 hover:text-zinc-100';
      var monthlyActive = state.view === 'monthly' ? 'bg-zinc-100 text-zinc-900' : 'bg-zinc-900 text-zinc-400 hover:text-zinc-100';
      html += '<button onclick="setView(\'entry\')" class="px-4 py-2 rounded-lg text-sm whitespace-nowrap ' + entryActive + '">Erfassen</button>';
      html += '<button onclick="setView(\'trend\')" class="px-4 py-2 rounded-lg text-sm whitespace-nowrap ' + trendActive + '">Trend</button>';
      html += '<button onclick="setView(\'history\')" class="px-4 py-2 rounded-lg text-sm whitespace-nowrap ' + historyActive + '">Einträge</button>';
      html += '<button onclick="setView(\'weekly\')" class="px-4 py-2 rounded-lg text-sm whitespace-nowrap ' + weeklyActive + '">Wochen</button>';
      html += '<button onclick="setView(\'monthly\')" class="px-4 py-2 rounded-lg text-sm whitespace-nowrap ' + monthlyActive + '">Monate</button>';
      html += '</div>';

      if (state.view === 'entry') {
        html += '<div class="card p-6">';
        
        html += '<div class="flex gap-2 mb-4">';
        html += '<button onclick="setPreset(\'08:00\',\'15:00\')" class="px-3 py-1.5 bg-zinc-800 rounded-lg text-xs text-zinc-400 hover:text-zinc-100 hover:bg-zinc-700">8–15 Uhr</button>';
        html += '<button onclick="setPreset(\'08:00\',\'12:00\')" class="px-3 py-1.5 bg-zinc-800 rounded-lg text-xs text-zinc-400 hover:text-zinc-100 hover:bg-zinc-700">8–12 Uhr</button>';
        html += '</div>';

        html += '<div class="flex gap-2 mb-6">';
        var rangeActive = state.entryMode === 'range' ? 'bg-zinc-700' : 'bg-zinc-800 text-zinc-500';
        var hoursActive = state.entryMode === 'hours' ? 'bg-zinc-700' : 'bg-zinc-800 text-zinc-500';
        html += '<button onclick="setEntryMode(\'range\')" class="flex-1 py-2 rounded-lg text-sm ' + rangeActive + '">Von – Bis</button>';
        html += '<button onclick="setEntryMode(\'hours\')" class="flex-1 py-2 rounded-lg text-sm ' + hoursActive + '">Stunden</button>';
        html += '</div>';

        html += '<div class="mb-4"><label class="text-zinc-500 text-xs block mb-2">Datum</label>';
        html += '<input type="date" value="' + state.date + '" onchange="updateDate(this.value)" class="w-full"></div>';

        if (state.entryMode === 'range') {
          html += '<div class="grid grid-cols-2 gap-4 mb-4">';
          html += '<div><label class="text-zinc-500 text-xs block mb-2">Von</label>';
          html += '<input type="time" value="' + state.startTime + '" onchange="updateStartTime(this.value)" class="w-full"></div>';
          html += '<div><label class="text-zinc-500 text-xs block mb-2">Bis</label>';
          html += '<input type="time" value="' + state.endTime + '" onchange="updateEndTime(this.value)" class="w-full"></div>';
          html += '</div>';
          var previewHours = calculateHours(state.startTime, state.endTime, true);
          html += '<div class="text-center text-zinc-500 text-sm mb-4">= ' + previewHours.toFixed(2) + ' Stunden</div>';
        } else {
          html += '<div class="mb-4"><label class="text-zinc-500 text-xs block mb-2">Stunden</label>';
          html += '<input type="number" step="0.25" value="' + state.hours + '" onchange="updateHours(this.value)" placeholder="z.B. 7.5" class="w-full"></div>';
        }

        html += '<div class="mb-4"><label class="text-zinc-500 text-xs block mb-2">Kategorie</label>';
        html += '<div class="flex flex-wrap gap-2">';
        for (var i = 0; i < state.categories.length; i++) {
          var cat = state.categories[i];
          var catActive = state.category === cat ? 'bg-zinc-100 text-zinc-900' : 'bg-zinc-800 text-zinc-400 hover:text-zinc-100';
          html += '<button onclick="setCategory(\'' + cat + '\')" class="px-3 py-1.5 rounded-lg text-sm ' + catActive + '">' + cat + '</button>';
        }
        html += '</div></div>';

        html += '<div class="mb-6"><label class="text-zinc-500 text-xs block mb-2">Notiz (optional)</label>';
        html += '<input type="text" value="' + (state.note || '') + '" onchange="updateNote(this.value)" placeholder="Was hast du gemacht?" class="w-full"></div>';

        html += '<button onclick="saveEntry()" class="w-full bg-zinc-100 text-zinc-900 rounded-lg py-3 font-medium hover:bg-white">Eintragen</button>';
        html += '</div>';
      }

      if (state.view === 'trend') {
        var chartDataWeeks = getLast8WeeksData();
        var chartDataMonths = getLast6MonthsData();
        var monthlyTarget = state.weeklyTarget * 4.33;
        var maxChartHoursWeeks = Math.max(state.weeklyTarget, Math.max.apply(null, chartDataWeeks.map(function(d) { return d.hours; })));
        var maxChartHoursMonths = Math.max(monthlyTarget, Math.max.apply(null, chartDataMonths.map(function(d) { return d.hours; })));
        var avgWeeks = getTrendAverage(chartDataWeeks);
        var avgMonths = getTrendAverage(chartDataMonths);

        html += '<div class="card p-6">';
        html += '<div class="flex gap-2 mb-6">';
        var weeksActive = state.trendView === 'weeks' ? 'bg-zinc-700' : 'bg-zinc-800 text-zinc-500';
        var monthsActive = state.trendView === 'months' ? 'bg-zinc-700' : 'bg-zinc-800 text-zinc-500';
        html += '<button onclick="setTrendView(\'weeks\')" class="flex-1 py-2 rounded-lg text-sm ' + weeksActive + '">Letzte 8 Wochen</button>';
        html += '<button onclick="setTrendView(\'months\')" class="flex-1 py-2 rounded-lg text-sm ' + monthsActive + '">Letzte 6 Monate</button>';
        html += '</div>';

        if (state.trendView === 'weeks') {
          html += '<h3 class="text-zinc-400 text-sm mb-4">Durchschnitt: ' + avgWeeks.toFixed(1) + 'h · Ziel: ' + state.weeklyTarget + 'h</h3>';
          html += '<div class="relative mb-4">';
          var goalLineWeeks = (state.weeklyTarget / maxChartHoursWeeks) * 160 + 40;
          html += '<div class="absolute w-full border-t border-dashed border-zinc-600" style="bottom:' + goalLineWeeks + 'px"></div>';
          html += '<div class="flex items-end gap-2" style="height:192px">';
          for (var w = 0; w < chartDataWeeks.length; w++) {
            var wd = chartDataWeeks[w];
            var barColor = wd.over ? 'bg-red-500' : 'bg-emerald-500';
            var labelColor = wd.over ? 'text-red-400' : 'text-zinc-400';
            var barHeight = Math.max(4, (wd.hours / maxChartHoursWeeks) * 160);
            html += '<div class="flex-1 flex flex-col items-center">';
            html += '<div class="w-full rounded-t ' + barColor + '" style="height:' + barHeight + 'px"></div>';
            html += '<div class="text-xs text-zinc-500 mt-2">' + wd.week + '</div>';
            html += '<div class="text-xs ' + labelColor + '">' + wd.hours.toFixed(0) + 'h</div>';
            html += '</div>';
          }
          html += '</div></div>';
        } else {
          html += '<h3 class="text-zinc-400 text-sm mb-4">Durchschnitt: ' + avgMonths.toFixed(1) + 'h · Ziel: ~' + monthlyTarget.toFixed(0) + 'h</h3>';
          html += '<div class="relative mb-4">';
          var goalLineMonths = (monthlyTarget / maxChartHoursMonths) * 160 + 40;
          html += '<div class="absolute w-full border-t border-dashed border-zinc-600" style="bottom:' + goalLineMonths + 'px"></div>';
          html += '<div class="flex items-end gap-2" style="height:192px">';
          for (var m = 0; m < chartDataMonths.length; m++) {
            var md = chartDataMonths[m];
            var barColorM = md.over ? 'bg-red-500' : 'bg-emerald-500';
            var labelColorM = md.over ? 'text-red-400' : 'text-zinc-400';
            var barHeightM = Math.max(4, (md.hours / maxChartHoursMonths) * 160);
            html += '<div class="flex-1 flex flex-col items-center">';
            html += '<div class="w-full rounded-t ' + barColorM + '" style="height:' + barHeightM + 'px"></div>';
            html += '<div class="text-xs text-zinc-500 mt-2">' + md.month + '</div>';
            html += '<div class="text-xs ' + labelColorM + '">' + md.hours.toFixed(0) + 'h</div>';
            html += '</div>';
          }
          html += '</div></div>';
        }

        html += '<div class="flex justify-center gap-6 text-xs text-zinc-500">';
        html += '<div class="flex items-center gap-2"><div class="w-3 h-3 rounded bg-emerald-500"></div><span>Unter Ziel</span></div>';
        html += '<div class="flex items-center gap-2"><div class="w-3 h-3 rounded bg-red-500"></div><span>Über Ziel</span></div>';
        html += '<div class="flex items-center gap-2"><div class="w-6 h-px border-t border-dashed border-zinc-600"></div><span>Ziel-Linie</span></div>';
        html += '</div>';
        html += '</div>';
      }

      if (state.view === 'history') {
        html += '<div class="space-y-2">';
        if (state.entries.length === 0) {
          html += '<div class="text-zinc-500 text-center py-8">Noch keine Einträge</div>';
        } else {
          var sorted = state.entries.slice().reverse();
          for (var j = 0; j < sorted.length; j++) {
            var entry = sorted[j];
            html += '<div class="card flex items-center justify-between">';
            html += '<div>';
            html += '<div class="flex items-center gap-3">';
            html += '<span class="text-lg font-light">' + entry.hours.toFixed(1) + 'h</span>';
            html += '<span class="text-zinc-500 text-sm">' + entry.category + '</span>';
            html += '</div>';
            html += '<div class="text-zinc-500 text-xs mt-1">' + formatDate(entry.date);
            if (entry.startTime) html += ' · ' + entry.startTime + '–' + entry.endTime;
            if (entry.note) html += ' · ' + entry.note;
            html += '</div></div>';
            html += '<button onclick="deleteEntry(' + entry.id + ')" class="text-zinc-600 hover:text-red-400 p-2 text-lg">✕</button>';
            html += '</div>';
          }
        }
        html += '</div>';
      }

      if (state.view === 'weekly') {
        var weeklyReport = getWeeklyReport();
        html += '<div class="space-y-3">';
        if (weeklyReport.length === 0) {
          html += '<div class="text-zinc-500 text-center py-8">Noch keine Daten</div>';
        } else {
          for (var wr = 0; wr < weeklyReport.length; wr++) {
            var weekItem = weeklyReport[wr];
            var weekKey = weekItem[0];
            var weekData = weekItem[1];
            var weekOverTarget = weekData.hours > state.weeklyTarget;
            var weekProgress = Math.min((weekData.hours / state.weeklyTarget) * 100, 100);
            html += '<div class="card">';
            html += '<div class="flex justify-between items-center">';
            html += '<span class="text-zinc-400">' + weekKey + '</span>';
            html += '<span class="text-xl font-light ' + (weekOverTarget ? 'text-red-400' : '') + '">' + weekData.hours.toFixed(1) + 'h</span>';
            html += '</div>';
            html += '<div class="mt-2 h-1.5 bg-zinc-800 rounded-full overflow-hidden">';
            html += '<div class="h-full ' + (weekOverTarget ? 'bg-red-500' : 'bg-emerald-500') + '" style="width:' + weekProgress + '%"></div>';
            html += '</div>';
            if (weekOverTarget) {
              html += '<div class="text-red-400 text-xs mt-2">+' + (weekData.hours - state.weeklyTarget).toFixed(1) + 'h über Ziel</div>';
            }
            html += '</div>';
          }
        }
        html += '</div>';
      }

      if (state.view === 'monthly') {
        var monthlyReport = getMonthlyReport();
        var monthlyTargetCalc = state.weeklyTarget * 4.33;
        html += '<div class="space-y-3">';
        if (monthlyReport.length === 0) {
          html += '<div class="text-zinc-500 text-center py-8">Noch keine Daten</div>';
        } else {
          for (var mr = 0; mr < monthlyReport.length; mr++) {
            var monthItem = monthlyReport[mr];
            var monthKey = monthItem[0];
            var monthData = monthItem[1];
            var monthName = new Date(monthKey + '-01').toLocaleDateString('de-AT', { month: 'long', year: 'numeric' });
            html += '<div class="card">';
            html += '<div class="flex justify-between items-center">';
            html += '<div>';
            html += '<span class="text-zinc-100">' + monthName + '</span>';
            html += '<div class="text-zinc-600 text-xs mt-1">Ziel: ~' + monthlyTargetCalc.toFixed(0) + 'h · ' + monthData.entries.length + ' Einträge</div>';
            html += '</div>';
            html += '<div class="flex items-center gap-3">';
            html += '<span class="text-xl font-light ' + (monthData.hours > monthlyTargetCalc ? 'text-red-400' : '') + '">' + monthData.hours.toFixed(1) + 'h</span>';
            html += '<button onclick="exportMonthlyCSV(\'' + monthKey + '\',' + JSON.stringify(monthData.entries) + ')" class="p-2 text-zinc-500 hover:text-zinc-100" title="CSV exportieren">';
            html += '<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">';
            html += '<path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>';
            html += '<polyline points="14 2 14 8 20 8"></polyline>';
            html += '<line x1="16" y1="13" x2="8" y2="13"></line>';
            html += '<line x1="16" y1="17" x2="8" y2="17"></line>';
            html += '</svg></button>';
            html += '<button onclick="generatePDF(\'' + monthKey + '\',' + JSON.stringify(monthData) + ')" class="p-2 text-zinc-500 hover:text-zinc-100" title="PDF exportieren">';
            html += '<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">';
            html += '<path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>';
            html += '<polyline points="7,10 12,15 17,10"></polyline>';
            html += '<line x1="12" y1="15" x2="12" y2="3"></line>';
            html += '</svg></button>';
            html += '</div></div>';
            html += '</div>';
          }
        }
        html += '</div>';
      }

      html += '<div class="mt-8 text-center text-zinc-700 text-xs">Worktime Tracker v1.0</div>';
      html += '</div>';

      document.getElementById('app').innerHTML = html;
    }

    loadData();
  </script>
</body>
</html>
