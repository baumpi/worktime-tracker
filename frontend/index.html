<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Arbeitszeit Tracker</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { background: #09090b; color: #fafafa; font-family: system-ui, -apple-system, sans-serif; }
    input, select { background: #27272a; border: none; border-radius: 0.5rem; padding: 0.75rem 1rem; color: #fafafa; outline: none; }
    input:focus { box-shadow: 0 0 0 2px #52525b; }
    input[type="date"]::-webkit-calendar-picker-indicator,
    input[type="time"]::-webkit-calendar-picker-indicator { filter: invert(1); }
    button { cursor: pointer; transition: all 0.2s; }
    .card { background: #18181b; border-radius: 0.75rem; padding: 1rem; }
  </style>
</head>
<body>
  <div id="app" class="min-h-screen p-4 md:p-8">
    <div class="max-w-2xl mx-auto">
      <div class="text-center py-8 text-zinc-500">Laden...</div>
    </div>
  </div>

  <script>
    var state = {
      entries: [],
      categories: ['Arbeit', 'W2Learn', 'Voice', 'Institut', 'Admin'],
      weeklyTarget: 35,
      dailyLimit: 8,
      autoPause: 0,
      view: 'entry',
      showSettings: false,
      entryMode: 'range',
      date: new Date().toISOString().split('T')[0],
      startTime: '08:00',
      endTime: '15:00',
      hours: '',
      category: 'Arbeit',
      note: ''
    };

    var API = '/api';

    async function loadData() {
      try {
        var res = await fetch(API + '/entries');
        state.entries = await res.json();
        
        var settingsRes = await fetch(API + '/settings');
        var settings = await settingsRes.json();
        if (settings.weeklyTarget) state.weeklyTarget = settings.weeklyTarget;
        if (settings.dailyLimit) state.dailyLimit = settings.dailyLimit;
        if (settings.autoPause) state.autoPause = settings.autoPause;
        if (settings.categories) state.categories = settings.categories;
      } catch (e) {
        console.error('Load error:', e);
      }
      render();
    }

    async function saveEntry() {
      var hrs = state.entryMode === 'range' 
        ? calculateHours(state.startTime, state.endTime, true)
        : parseFloat(state.hours);
      
      if (!hrs || hrs <= 0) return;

      var entry = {
        date: state.date,
        hours: hrs,
        category: state.category,
        note: state.note,
        startTime: state.entryMode === 'range' ? state.startTime : null,
        endTime: state.entryMode === 'range' ? state.endTime : null
      };

      var res = await fetch(API + '/entries', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(entry)
      });
      var saved = await res.json();
      state.entries.push(saved);
      state.hours = '';
      state.note = '';
      render();
    }

    async function deleteEntry(id) {
      await fetch(API + '/entries/' + id, { method: 'DELETE' });
      state.entries = state.entries.filter(function(e) { return e.id !== id; });
      render();
    }

    async function saveSettings() {
      await fetch(API + '/settings', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          weeklyTarget: state.weeklyTarget,
          dailyLimit: state.dailyLimit,
          autoPause: state.autoPause,
          categories: state.categories
        })
      });
      state.showSettings = false;
      render();
    }

    function calculateHours(start, end, withPause) {
      if (!start || !end) return 0;
      var s = start.split(':').map(Number);
      var e = end.split(':').map(Number);
      var hrs = ((e[0] * 60 + e[1]) - (s[0] * 60 + s[1])) / 60;
      if (withPause && state.autoPause > 0 && hrs > 6) {
        hrs -= state.autoPause / 60;
      }
      return Math.max(0, hrs);
    }

    function getStats(startDate, endDate) {
      return state.entries
        .filter(function(e) { return e.date >= startDate && e.date <= endDate; })
        .reduce(function(sum, e) { return sum + e.hours; }, 0);
    }

    function getTodayHours() {
      var today = new Date().toISOString().split('T')[0];
      return getStats(today, today);
    }

    function getWeekHours() {
      var now = new Date();
      var day = now.getDay();
      var monday = new Date(now);
      monday.setDate(now.getDate() - (day === 0 ? 6 : day - 1));
      var sunday = new Date(monday);
      sunday.setDate(monday.getDate() + 6);
      return getStats(monday.toISOString().split('T')[0], sunday.toISOString().split('T')[0]);
    }

    function getMonthHours() {
      var now = new Date();
      var first = new Date(now.getFullYear(), now.getMonth(), 1).toISOString().split('T')[0];
      var last = new Date(now.getFullYear(), now.getMonth() + 1, 0).toISOString().split('T')[0];
      return getStats(first, last);
    }

    function formatDate(dateStr) {
      return new Date(dateStr).toLocaleDateString('de-AT', { weekday: 'short', day: 'numeric', month: 'short' });
    }

    function setView(v) { state.view = v; render(); }
    function setEntryMode(m) { state.entryMode = m; render(); }
    function setCategory(c) { state.category = c; render(); }
    function setPreset(start, end) { state.startTime = start; state.endTime = end; state.entryMode = 'range'; render(); }
    function toggleSettings() { state.showSettings = !state.showSettings; render(); }
    function updateDate(v) { state.date = v; }
    function updateStartTime(v) { state.startTime = v; render(); }
    function updateEndTime(v) { state.endTime = v; render(); }
    function updateHours(v) { state.hours = v; }
    function updateNote(v) { state.note = v; }
    function updateWeeklyTarget(v) { state.weeklyTarget = parseFloat(v) || 35; }
    function updateDailyLimit(v) { state.dailyLimit = parseFloat(v) || 8; }
    function updateAutoPause(v) { state.autoPause = parseInt(v) || 0; }

    function render() {
      var weekHours = getWeekHours();
      var remaining = Math.max(0, state.weeklyTarget - weekHours);
      var progress = (weekHours / state.weeklyTarget) * 100;
      var progressColor = progress > 100 ? 'bg-red-500' : progress > 85 ? 'bg-amber-500' : 'bg-emerald-500';

      var html = '<div class="max-w-2xl mx-auto">';
      
      html += '<div class="flex justify-between items-start mb-6">';
      html += '<div><h1 class="text-2xl font-light mb-1">Arbeitszeit</h1>';
      html += '<p class="text-zinc-500 text-sm">Ziel: ' + state.weeklyTarget + 'h / Woche</p></div>';
      html += '<button onclick="toggleSettings()" class="p-2 text-zinc-500 hover:text-zinc-100 text-xl">⚙️</button>';
      html += '</div>';

      if (state.showSettings) {
        html += '<div class="card mb-6 space-y-4">';
        html += '<div class="grid grid-cols-3 gap-4">';
        html += '<div><label class="text-zinc-400 text-xs block mb-2">Wochenziel (h)</label>';
        html += '<input type="number" value="' + state.weeklyTarget + '" onchange="updateWeeklyTarget(this.value)" class="w-full"></div>';
        html += '<div><label class="text-zinc-400 text-xs block mb-2">Tageslimit (h)</label>';
        html += '<input type="number" value="' + state.dailyLimit + '" onchange="updateDailyLimit(this.value)" class="w-full"></div>';
        html += '<div><label class="text-zinc-400 text-xs block mb-2">Auto-Pause (min)</label>';
        html += '<input type="number" value="' + state.autoPause + '" onchange="updateAutoPause(this.value)" class="w-full"></div>';
        html += '</div>';
        html += '<div class="flex gap-2 justify-end">';
        html += '<button onclick="toggleSettings()" class="px-4 py-2 text-zinc-500 hover:text-zinc-100">Abbrechen</button>';
        html += '<button onclick="saveSettings()" class="px-4 py-2 bg-zinc-100 text-zinc-900 rounded-lg hover:bg-white">Speichern</button>';
        html += '</div></div>';
      }

      html += '<div class="card mb-6 bg-gradient-to-r from-zinc-900 to-zinc-800 p-6">';
      html += '<div class="text-zinc-400 text-sm mb-1">Diese Woche noch frei</div>';
      var remainingColor = remaining === 0 ? 'text-amber-400' : 'text-emerald-400';
      html += '<div class="text-4xl font-light ' + remainingColor + '">' + remaining.toFixed(1) + 'h</div>';
      if (weekHours > state.weeklyTarget) {
        html += '<div class="text-red-400 text-sm mt-2">⚠️ ' + (weekHours - state.weeklyTarget).toFixed(1) + 'h über dem Ziel</div>';
      }
      html += '</div>';

      html += '<div class="grid grid-cols-3 gap-4 mb-6">';
      html += '<div class="card"><div class="text-zinc-500 text-xs mb-1">Heute</div>';
      html += '<div class="text-2xl font-light">' + getTodayHours().toFixed(1) + 'h</div></div>';
      html += '<div class="card"><div class="text-zinc-500 text-xs mb-1">Diese Woche</div>';
      var weekColor = weekHours > state.weeklyTarget ? 'text-red-400' : '';
      html += '<div class="text-2xl font-light ' + weekColor + '">' + weekHours.toFixed(1) + 'h</div></div>';
      html += '<div class="card"><div class="text-zinc-500 text-xs mb-1">Dieser Monat</div>';
      html += '<div class="text-2xl font-light">' + getMonthHours().toFixed(1) + 'h</div></div>';
      html += '</div>';

      html += '<div class="mb-8">';
      html += '<div class="flex justify-between text-xs text-zinc-500 mb-2"><span>Wochenziel</span><span>' + weekHours.toFixed(1) + ' / ' + state.weeklyTarget + 'h</span></div>';
      html += '<div class="h-2 bg-zinc-800 rounded-full overflow-hidden">';
      html += '<div class="h-full transition-all duration-500 ' + progressColor + '" style="width:' + Math.min(progress, 100) + '%"></div>';
      html += '</div></div>';

      html += '<div class="flex gap-2 mb-6">';
      var entryActive = state.view === 'entry' ? 'bg-zinc-100 text-zinc-900' : 'bg-zinc-900 text-zinc-400 hover:text-zinc-100';
      var historyActive = state.view === 'history' ? 'bg-zinc-100 text-zinc-900' : 'bg-zinc-900 text-zinc-400 hover:text-zinc-100';
      html += '<button onclick="setView(\'entry\')" class="px-4 py-2 rounded-lg text-sm ' + entryActive + '">Erfassen</button>';
      html += '<button onclick="setView(\'history\')" class="px-4 py-2 rounded-lg text-sm ' + historyActive + '">Einträge</button>';
      html += '</div>';

      if (state.view === 'entry') {
        html += '<div class="card p-6">';
        
        html += '<div class="flex gap-2 mb-4">';
        html += '<button onclick="setPreset(\'08:00\',\'15:00\')" class="px-3 py-1.5 bg-zinc-800 rounded-lg text-xs text-zinc-400 hover:text-zinc-100 hover:bg-zinc-700">8–15 Uhr</button>';
        html += '<button onclick="setPreset(\'08:00\',\'12:00\')" class="px-3 py-1.5 bg-zinc-800 rounded-lg text-xs text-zinc-400 hover:text-zinc-100 hover:bg-zinc-700">8–12 Uhr</button>';
        html += '</div>';

        html += '<div class="flex gap-2 mb-6">';
        var rangeActive = state.entryMode === 'range' ? 'bg-zinc-700' : 'bg-zinc-800 text-zinc-500';
        var hoursActive = state.entryMode === 'hours' ? 'bg-zinc-700' : 'bg-zinc-800 text-zinc-500';
        html += '<button onclick="setEntryMode(\'range\')" class="flex-1 py-2 rounded-lg text-sm ' + rangeActive + '">Von – Bis</button>';
        html += '<button onclick="setEntryMode(\'hours\')" class="flex-1 py-2 rounded-lg text-sm ' + hoursActive + '">Stunden</button>';
        html += '</div>';

        html += '<div class="mb-4"><label class="text-zinc-500 text-xs block mb-2">Datum</label>';
        html += '<input type="date" value="' + state.date + '" onchange="updateDate(this.value)" class="w-full"></div>';

        if (state.entryMode === 'range') {
          html += '<div class="grid grid-cols-2 gap-4 mb-4">';
          html += '<div><label class="text-zinc-500 text-xs block mb-2">Von</label>';
          html += '<input type="time" value="' + state.startTime + '" onchange="updateStartTime(this.value)" class="w-full"></div>';
          html += '<div><label class="text-zinc-500 text-xs block mb-2">Bis</label>';
          html += '<input type="time" value="' + state.endTime + '" onchange="updateEndTime(this.value)" class="w-full"></div>';
          html += '</div>';
          var previewHours = calculateHours(state.startTime, state.endTime, true);
          html += '<div class="text-center text-zinc-500 text-sm mb-4">= ' + previewHours.toFixed(2) + ' Stunden</div>';
        } else {
          html += '<div class="mb-4"><label class="text-zinc-500 text-xs block mb-2">Stunden</label>';
          html += '<input type="number" step="0.25" value="' + state.hours + '" onchange="updateHours(this.value)" placeholder="z.B. 7.5" class="w-full"></div>';
        }

        html += '<div class="mb-4"><label class="text-zinc-500 text-xs block mb-2">Kategorie</label>';
        html += '<div class="flex flex-wrap gap-2">';
        for (var i = 0; i < state.categories.length; i++) {
          var cat = state.categories[i];
          var catActive = state.category === cat ? 'bg-zinc-100 text-zinc-900' : 'bg-zinc-800 text-zinc-400 hover:text-zinc-100';
          html += '<button onclick="setCategory(\'' + cat + '\')" class="px-3 py-1.5 rounded-lg text-sm ' + catActive + '">' + cat + '</button>';
        }
        html += '</div></div>';

        html += '<div class="mb-6"><label class="text-zinc-500 text-xs block mb-2">Notiz (optional)</label>';
        html += '<input type="text" value="' + (state.note || '') + '" onchange="updateNote(this.value)" placeholder="Was hast du gemacht?" class="w-full"></div>';

        html += '<button onclick="saveEntry()" class="w-full bg-zinc-100 text-zinc-900 rounded-lg py-3 font-medium hover:bg-white">Eintragen</button>';
        html += '</div>';
      }

      if (state.view === 'history') {
        html += '<div class="space-y-2">';
        if (state.entries.length === 0) {
          html += '<div class="text-zinc-500 text-center py-8">Noch keine Einträge</div>';
        } else {
          var sorted = state.entries.slice().reverse();
          for (var j = 0; j < sorted.length; j++) {
            var entry = sorted[j];
            html += '<div class="card flex items-center justify-between">';
            html += '<div>';
            html += '<div class="flex items-center gap-3">';
            html += '<span class="text-lg font-light">' + entry.hours.toFixed(1) + 'h</span>';
            html += '<span class="text-zinc-500 text-sm">' + entry.category + '</span>';
            html += '</div>';
            html += '<div class="text-zinc-500 text-xs mt-1">' + formatDate(entry.date);
            if (entry.startTime) html += ' · ' + entry.startTime + '–' + entry.endTime;
            if (entry.note) html += ' · ' + entry.note;
            html += '</div></div>';
            html += '<button onclick="deleteEntry(' + entry.id + ')" class="text-zinc-600 hover:text-red-400 p-2 text-lg">✕</button>';
            html += '</div>';
          }
        }
        html += '</div>';
      }

      html += '<div class="mt-8 text-center text-zinc-700 text-xs">Worktime Tracker v1.0</div>';
      html += '</div>';

      document.getElementById('app').innerHTML = html;
    }

    loadData();
  </script>
</body>
</html>
